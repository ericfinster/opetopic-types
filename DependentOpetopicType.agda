{-# OPTIONS --without-K --rewriting #-}

open import MiniHoTT
open import MiniUniverse
open import AbsoluteOpetopicTypes

module DependentOpetopicType where

  --
  --  The Universe of Dependent Opetopic Types
  --

  ğ•†â†“ : âˆ€ {â„“ : Level} {n : â„•} (â„“â†“ : Level) (X : ğ•† â„“ n)
    â†’ Set (â„“-max â„“ (â„“-suc â„“â†“))
    
  Frmâ†“ : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} (Xâ†“ : ğ•†â†“ â„“â†“ X)
    (f : Frm X) â†’ Set â„“â†“
    
  Cnsâ†“ : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} (Xâ†“ : ğ•†â†“ â„“â†“ X)
    â†’ {f : Frm X} {P : â„™} {t : El P â†’ Frm X} (c : Cns X f P t)
    â†’ (fâ†“ : Frmâ†“ Xâ†“ f) (tâ†“ : (p : El P) â†’ Frmâ†“ Xâ†“ (t p))
    â†’ Set â„“â†“

  --
  --  Dependent Operations 
  --
  
  record Oprâ†“ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {f : Frm X}
      (Xâ†“ : ğ•†â†“ â„“â†“ X) (fâ†“ : Frmâ†“ Xâ†“ f) (op : Opr X f) : Set â„“â†“ where
    eta-equality
    inductive
    constructor âŸª_,_âŸ«â‚’â‚šâ†“
    field
      typâ†“ : (p : El (pos op)) â†’ Frmâ†“ Xâ†“ (typ op p)
      cnsâ†“ : Cnsâ†“ Xâ†“ (cns op) fâ†“ typâ†“ 

  open Oprâ†“ public

  --
  --  Dependent Frame Eliminators
  --

  postulate

    âŠ¥â‚š-Frmâ†“-rec : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n}
      â†’ {Xâ†“ : ğ•†â†“ â„“â†“ X} 
      â†’ (p : El âŠ¥â‚š) â†’ Frmâ†“ Xâ†“ (âŠ¥â‚š-Frm-rec p)

    âŠ¤â‚š-Frmâ†“-rec : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {f : Frm X} (fâ†“ : Frmâ†“ Xâ†“ f)
      â†’ (p : El âŠ¤â‚š) â†’ Frmâ†“ Xâ†“ (âŠ¤â‚š-Frm-rec f p) 

    âŠ¤â‚š-Frmâ†“-rec-Î² : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {f : Frm X} (fâ†“ : Frmâ†“ Xâ†“ f) (p : El âŠ¤â‚š)
      â†’ âŠ¤â‚š-Frmâ†“-rec fâ†“ p â†¦ fâ†“
    {-# REWRITE âŠ¤â‚š-Frmâ†“-rec-Î² #-}

    âŠ”â‚š-Frmâ†“-rec : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U V : â„™} {inlâ‚š* : El U â†’ Frm X} {inrâ‚š* : El V â†’ Frm X}
      â†’ (inlâ†“â‚š* : (u : El U) â†’ Frmâ†“ Xâ†“ (inlâ‚š* u))
      â†’ (inrâ†“â‚š* : (v : El V) â†’ Frmâ†“ Xâ†“ (inrâ‚š* v))
      â†’ (uv : El (U âŠ”â‚š V)) â†’ Frmâ†“ Xâ†“ (âŠ”â‚š-Frm-rec inlâ‚š* inrâ‚š* uv) 

    âŠ”â‚š-Frmâ†“-rec-inl-Î² : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U V : â„™} {inlâ‚š* : El U â†’ Frm X} {inrâ‚š* : El V â†’ Frm X}
      â†’ (inlâ†“â‚š* : (u : El U) â†’ Frmâ†“ Xâ†“ (inlâ‚š* u))
      â†’ (inrâ†“â‚š* : (v : El V) â†’ Frmâ†“ Xâ†“ (inrâ‚š* v))
      â†’ (u : El U) â†’ âŠ”â‚š-Frmâ†“-rec inlâ†“â‚š* inrâ†“â‚š* (inlâ‚š V u) â†¦ inlâ†“â‚š* u
    {-# REWRITE âŠ”â‚š-Frmâ†“-rec-inl-Î² #-}

    âŠ”â‚š-Frmâ†“-rec-inr-Î² : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U V : â„™} {inlâ‚š* : El U â†’ Frm X} {inrâ‚š* : El V â†’ Frm X}
      â†’ (inlâ†“â‚š* : (u : El U) â†’ Frmâ†“ Xâ†“ (inlâ‚š* u))
      â†’ (inrâ†“â‚š* : (v : El V) â†’ Frmâ†“ Xâ†“ (inrâ‚š* v))
      â†’ (v : El V) â†’ âŠ”â‚š-Frmâ†“-rec inlâ†“â‚š* inrâ†“â‚š* (inrâ‚š U v) â†¦ inrâ†“â‚š* v
    {-# REWRITE âŠ”â‚š-Frmâ†“-rec-inr-Î² #-}

    Î£â‚š-Frmâ†“-rec : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {V : El U â†’ â„™}
      â†’ {Ï : (u : El U) â†’ El (V u) â†’ Frm X}
      â†’ (Ïâ†“ : (u : El U) (v : El (V u)) â†’ Frmâ†“ Xâ†“ (Ï u v))
      â†’ (uv : El (Î£â‚š U V)) â†’ Frmâ†“ Xâ†“ (Î£â‚š-Frm-rec Ï uv)

    Î£â‚š-Frmâ†“-rec-Î² : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {V : El U â†’ â„™}
      â†’ {Ï : (u : El U) â†’ El (V u) â†’ Frm X}
      â†’ (Ïâ†“ : (u : El U) (v : El (V u)) â†’ Frmâ†“ Xâ†“ (Ï u v))
      â†’ (u : El U) (v : El (V u))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ âŸ¦ U , V âˆ£ u , v âŸ§â‚š â†¦ Ïâ†“ u v
    {-# REWRITE Î£â‚š-Frmâ†“-rec-Î² #-}

    --
    --  Dependent Frame Recursor Laws
    --
    
    âŠ”â‚š-Frmâ†“-rec-unit-r : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {inlâ‚š* : El U â†’ Frm X} {inrâ‚š* : El âŠ¥â‚š â†’ Frm X}
      â†’ (inlâ†“â‚š* : (u : El U) â†’ Frmâ†“ Xâ†“ (inlâ‚š* u))
      â†’ (inrâ†“â‚š* : (b : El âŠ¥â‚š) â†’ Frmâ†“ Xâ†“ (inrâ‚š* b))
      â†’ âŠ”â‚š-Frmâ†“-rec inlâ†“â‚š* inrâ†“â‚š* â†¦ inlâ†“â‚š* 
    {-# REWRITE âŠ”â‚š-Frmâ†“-rec-unit-r #-}
    
    âŠ”â‚š-Frmâ†“-rec-unit-l : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {V : â„™} {inlâ‚š* : El âŠ¥â‚š â†’ Frm X} {inrâ‚š* : El V â†’ Frm X}
      â†’ (inlâ†“â‚š* : (b : El âŠ¥â‚š) â†’ Frmâ†“ Xâ†“ (inlâ‚š* b))
      â†’ (inrâ†“â‚š* : (v : El V) â†’ Frmâ†“ Xâ†“ (inrâ‚š* v))
      â†’ âŠ”â‚š-Frmâ†“-rec inlâ†“â‚š* inrâ†“â‚š* â†¦ inrâ†“â‚š* 
    {-# REWRITE âŠ”â‚š-Frmâ†“-rec-unit-l #-}
    
    âŠ”â‚š-Frmâ†“-rec-assoc : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U V W : â„™} {inlâ‚š* : El (U âŠ”â‚š V) â†’ Frm X}
      â†’ {inrâ‚š* : El W â†’ Frm X}
      â†’ (inlâ†“â‚š* : (uv : El (U âŠ”â‚š V)) â†’ Frmâ†“ Xâ†“ (inlâ‚š* uv))
      â†’ (inrâ†“â‚š* : (w : El W) â†’ Frmâ†“ Xâ†“ (inrâ‚š* w))
      â†’ âŠ”â‚š-Frmâ†“-rec {U = U âŠ”â‚š V} {V = W} inlâ†“â‚š* inrâ†“â‚š* â†¦
          âŠ”â‚š-Frmâ†“-rec {U = U} {V = V âŠ”â‚š W} (Î» u â†’ inlâ†“â‚š* (inlâ‚š V u))
            (âŠ”â‚š-Frmâ†“-rec {U = V} {V = W} (Î» v â†’ inlâ†“â‚š* (inrâ‚š U v)) inrâ†“â‚š*) 
    {-# REWRITE âŠ”â‚š-Frmâ†“-rec-assoc #-}

    Î£â‚š-Frmâ†“-rec-unit-r : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {Ï : (u : El U) (t : El âŠ¤â‚š) â†’ Frm X}
      â†’ (Ïâ†“ : (u : El U) (t : El âŠ¤â‚š) â†’ Frmâ†“ Xâ†“ (Ï u t))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ â†¦ (Î» u â†’ Ïâ†“ u ttâ‚š)
    {-# REWRITE Î£â‚š-Frmâ†“-rec-unit-r #-}

    Î£â‚š-Frmâ†“-rec-unit-l : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {V : El âŠ¤â‚š â†’ â„™} {Ï : (t : El âŠ¤â‚š) â†’ El (V t) â†’ Frm X}
      â†’ (Ïâ†“ : (t : El âŠ¤â‚š) (v : El (V t)) â†’ Frmâ†“ Xâ†“ (Ï t v))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ â†¦ Ïâ†“ ttâ‚š
    {-# REWRITE Î£â‚š-Frmâ†“-rec-unit-l #-}

    Î£â‚š-Frmâ†“-rec-zero-r : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {Ï : (u : El U) â†’ El âŠ¥â‚š â†’ Frm X}
      â†’ (Ïâ†“ : (u : El U) (b : El âŠ¥â‚š) â†’ Frmâ†“ Xâ†“ (Ï u b))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ â†¦ âŠ¥â‚š-Frmâ†“-rec 
    {-# REWRITE Î£â‚š-Frmâ†“-rec-zero-r #-}

    Î£â‚š-Frmâ†“-rec-zero-l : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {V : El âŠ¥â‚š â†’ â„™} {Ï : (b : El âŠ¥â‚š) â†’ El (V b) â†’ Frm X}
      â†’ (Ïâ†“ : (b : El âŠ¥â‚š) (v : El (V b)) â†’ Frmâ†“ Xâ†“ (Ï b v))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ â†¦ âŠ¥â‚š-Frmâ†“-rec
    {-# REWRITE Î£â‚š-Frmâ†“-rec-zero-l #-}

    Î£â‚š-Frmâ†“-rec-assoc : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {V : El U â†’ â„™} {W : El (Î£â‚š U V) â†’ â„™}
      â†’ {Ï : (uv : El (Î£â‚š U V)) â†’ El (W uv) â†’ Frm X}
      â†’ (Ïâ†“ : (uv : El (Î£â‚š U V)) (w : El (W uv)) â†’ Frmâ†“ Xâ†“ (Ï uv w))
      â†’ Î£â‚š-Frmâ†“-rec {U = Î£â‚š U V} {V = W} Ïâ†“ â†¦
          Î£â‚š-Frmâ†“-rec {U = U} {V = Î» u â†’ Î£â‚š (V u) (Î» v â†’ W âŸ¦ U , V âˆ£ u , v âŸ§â‚š)}
            (Î» u â†’ Î£â‚š-Frmâ†“-rec {U = V u} {V = (Î» v â†’ W âŸ¦ U , V âˆ£ u , v âŸ§â‚š)}
                     (Î» v w â†’ Ïâ†“ âŸ¦ U , V âˆ£ u , v âŸ§â‚š w))
    {-# REWRITE Î£â‚š-Frmâ†“-rec-assoc #-}

    âŠ”â‚š-Î£â‚š-Frmâ†“-rec-distrib-r : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U V : â„™} {W : El (U âŠ”â‚š V) â†’ â„™}
      â†’ {Ï : (uv : El (U âŠ”â‚š V)) â†’ El (W uv) â†’ Frm X}
      â†’ (Ïâ†“ : (uv : El (U âŠ”â‚š V)) (w : El (W uv)) â†’ Frmâ†“ Xâ†“ (Ï uv w))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ â†¦
          âŠ”â‚š-Frmâ†“-rec {U = Î£â‚š U (Î» u â†’ W (inlâ‚š V u))}
                      {V = Î£â‚š V (Î» v â†’ W (inrâ‚š U v))}
            (Î£â‚š-Frmâ†“-rec {U = U} {V = (Î» u â†’ W (inlâ‚š V u))} (Î» u w â†’ Ïâ†“ (inlâ‚š V u) w))
            (Î£â‚š-Frmâ†“-rec {U = V} {V = (Î» v â†’ W (inrâ‚š U v))} (Î» v w â†’ Ïâ†“ (inrâ‚š U v) w))
    {-# REWRITE âŠ”â‚š-Î£â‚š-Frmâ†“-rec-distrib-r #-}

    âŠ”â‚š-Î£â‚š-Frmâ†“-rec-distrib-l : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {U : â„™} {V : El U â†’ â„™} {W : El U â†’ â„™}
      â†’ {Ï : (u : El U) (vw : El (V u âŠ”â‚š W u)) â†’ Frm X}
      â†’ (Ïâ†“ : (u : El U) (vw : El (V u âŠ”â‚š W u)) â†’ Frmâ†“ Xâ†“ (Ï u vw))
      â†’ Î£â‚š-Frmâ†“-rec Ïâ†“ â†¦
          âŠ”â‚š-Frmâ†“-rec {U = Î£â‚š U V} {V = Î£â‚š U W}
            (Î£â‚š-Frmâ†“-rec {V = V} (Î» u v â†’ Ïâ†“ u (inlâ‚š (W u) v)))
            (Î£â‚š-Frmâ†“-rec {V = W} (Î» u w â†’ Ïâ†“ u (inrâ‚š (V u) w))) 
    {-# REWRITE âŠ”â‚š-Î£â‚š-Frmâ†“-rec-distrib-l #-}

  --
  --  Dependent Frames
  --

  record Frmâ†“â‚› {â„“ â„“â†“} {n : â„•} {Xâ‚™ : ğ•† â„“ n} {Xâ‚›â‚™ : Frm Xâ‚™ â†’ Set â„“} {Xâ†“â‚™ : ğ•†â†“ â„“â†“ Xâ‚™}
    (Xâ†“â‚›â‚™ : {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“)
    {f : Frm Xâ‚™} {x : Xâ‚›â‚™ f} (fâ‚› : Frmâ‚› Xâ‚›â‚™ f x)
    (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (xâ†“ : Xâ†“â‚›â‚™ fâ†“ x) : Set â„“â†“ where
    eta-equality
    inductive
    constructor âŸª_,_âŸ«fâ†“
    field
      oprâ†“ : Oprâ†“ Xâ†“â‚™ fâ†“ (opr fâ‚›)
      decâ†“ : (p : El (pos (opr fâ‚›))) â†’ Xâ†“â‚›â‚™ (typâ†“ oprâ†“ p) (dec fâ‚› p)

  open Frmâ†“â‚› public
      
  --
  --  Dependent Opetopic Types 
  --
  
  ğ•†â†“ {n = O} â„“â†“ X = X â†’ Set â„“â†“
  ğ•†â†“ {n = S n} â„“â†“ (Xâ‚™ , Xâ‚›â‚™) =
    Î£ (ğ•†â†“ â„“â†“ Xâ‚™) (Î» Xâ†“â‚™ â†’
    {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“)
  
  Frmâ†“ {n = O} {X} Xâ†“ âŸª x , P , t âŸ« =
    (Xâ†“ x) Ã— ((p : El P) â†’ Xâ†“ (t p))
  Frmâ†“ {n = S n} {Xâ‚™ , Xâ‚›â‚™} (Xâ†“â‚™ , Xâ†“â‚›â‚™) (f , x , fâ‚›) =
    Î£ (Frmâ†“ Xâ†“â‚™ f) (Î» fâ†“ â†’
    Î£ (Xâ†“â‚›â‚™ fâ†“ x) (Î» xâ†“ â†’
    Frmâ†“â‚› Xâ†“â‚›â‚™ fâ‚› fâ†“ xâ†“))

  --
  --  Dependent Monadic Structure
  --

  Î·â†“-cns : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
    â†’ {f : Frm X} (fâ†“ : Frmâ†“ Xâ†“ f)
    â†’ Cnsâ†“ Xâ†“ (Î·-cns f) fâ†“ (âŠ¤â‚š-Frmâ†“-rec fâ†“) 

  Î·â†“ : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
    â†’ {f : Frm X} (fâ†“ : Frmâ†“ Xâ†“ f)
    â†’ Oprâ†“ Xâ†“ fâ†“ (Î· f)
  Î·â†“ fâ†“ = âŸª _ , Î·â†“-cns fâ†“ âŸ«â‚’â‚šâ†“

  Î·â†“-frm : âˆ€ {â„“ â„“â†“} {n : â„•} {Xâ‚™ : ğ•† â„“ n} {Xâ‚›â‚™ : Frm Xâ‚™ â†’ Set â„“}
    â†’ {Xâ†“â‚™ : ğ•†â†“ â„“â†“ Xâ‚™} {Xâ†“â‚›â‚™ : {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“}
    â†’ {f : Frm Xâ‚™} {x : Xâ‚›â‚™ f}
    â†’ (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (xâ†“ : Xâ†“â‚›â‚™ fâ†“ x)
    â†’ Frmâ†“â‚› Xâ†“â‚›â‚™ (Î·-frm f x) fâ†“ xâ†“
  Î·â†“-frm {Xâ‚›â‚™ = Xâ‚›â‚™} {Xâ†“â‚›â‚™ = Xâ†“â‚›â‚™} {f} {x} fâ†“ xâ†“ =
    âŸª Î·â†“ fâ†“ , âŠ¤â‚š-elim (Î» p â†’ Xâ†“â‚›â‚™ (typâ†“ (Î·â†“ fâ†“) p) (dec (Î·-frm {Xâ‚›â‚™ = Xâ‚›â‚™} f x) p)) xâ†“ âŸ«fâ†“ 

  Î¼â†“-cns : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
    â†’ {f : Frm X} {c : Opr X f}
    â†’ {Î´ : (p : El (pos c)) â†’ Opr X (typ c p)}
    â†’ {fâ†“ : Frmâ†“ Xâ†“ f} (câ†“ : Oprâ†“ Xâ†“ fâ†“ c)
    â†’ (Î´â†“ : (p : El (pos c)) â†’ Oprâ†“ Xâ†“ (typâ†“ câ†“ p) (Î´ p))
    â†’ Cnsâ†“ Xâ†“ (Î¼-cns c Î´ ) fâ†“ (Î£â‚š-Frmâ†“-rec (Î» p q â†’ typâ†“ (Î´â†“ p) q)) 

  Î¼â†“ : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
    â†’ {f : Frm X} {c : Opr X f}
    â†’ {Î´ : (p : El (pos c)) â†’ Opr X (typ c p)}
    â†’ {fâ†“ : Frmâ†“ Xâ†“ f} (câ†“ : Oprâ†“ Xâ†“ fâ†“ c)
    â†’ (Î´â†“ : (p : El (pos c)) â†’ Oprâ†“ Xâ†“ (typâ†“ câ†“ p) (Î´ p))
    â†’ Oprâ†“ Xâ†“ fâ†“ (Î¼ c Î´)
  Î¼â†“ câ†“ Î´â†“ =  âŸª _ , Î¼â†“-cns câ†“ Î´â†“  âŸ«â‚’â‚šâ†“ 

  Î¼â†“-frm : âˆ€ {â„“ â„“â†“} {n : â„•} {Xâ‚™ : ğ•† â„“ n} {Xâ‚›â‚™ : Frm Xâ‚™ â†’ Set â„“}
    â†’ {Xâ†“â‚™ : ğ•†â†“ â„“â†“ Xâ‚™} {Xâ†“â‚›â‚™ : {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“}
    â†’ {f : Frm Xâ‚™} {x : Xâ‚›â‚™ f} {fâ‚› : Frmâ‚› Xâ‚›â‚™ f x}
    â†’ {Ï• : (p : El (pos (opr fâ‚›))) â†’ Frmâ‚› Xâ‚›â‚™ (typ (opr fâ‚›) p) (dec fâ‚› p)}
    â†’ {fâ†“ : Frmâ†“ Xâ†“â‚™ f} {xâ†“ : Xâ†“â‚›â‚™ fâ†“ x} (fâ†“â‚› : Frmâ†“â‚› Xâ†“â‚›â‚™ fâ‚› fâ†“ xâ†“)
    â†’ (Ï•â†“ : (p : El (pos (opr fâ‚›))) â†’ Frmâ†“â‚› Xâ†“â‚›â‚™ (Ï• p) (typâ†“ (oprâ†“ fâ†“â‚›) p) (decâ†“ fâ†“â‚› p))
    â†’ Frmâ†“â‚› Xâ†“â‚›â‚™ (Î¼-frm fâ‚› Ï•) fâ†“ xâ†“
  Î¼â†“-frm fâ†“â‚› Ï•â†“ = âŸª Î¼â†“ (oprâ†“ fâ†“â‚›) (Î» p â†’ oprâ†“ (Ï•â†“ p)) ,
    Î£â‚š-elim _ _ _ (Î» p q â†’ decâ†“ (Ï•â†“ p) q) âŸ«fâ†“

  --
  --  Dependent Monadic Laws
  --

  postulate

    Î¼â†“-unit-r : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {f : Frm X} {c : Opr X f}
      â†’ {fâ†“ : Frmâ†“ Xâ†“ f} (câ†“ : Oprâ†“ Xâ†“ fâ†“ c)
      â†’ Î¼â†“-cns câ†“ (Î» p â†’ Î·â†“ (typâ†“ câ†“ p)) â†¦ cnsâ†“ câ†“
    {-# REWRITE Î¼â†“-unit-r #-}

    Î¼â†“-unit-l : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {f : Frm X} {Î´ : (p : El (pos (Î· f))) â†’ Opr X (typ (Î· f) p)}
      â†’ (fâ†“ : Frmâ†“ Xâ†“ f) (Î´â†“ : (p : El (pos (Î· f))) â†’ Oprâ†“ Xâ†“ (typâ†“ (Î·â†“ fâ†“) p) (Î´ p))
      â†’ Î¼â†“-cns (Î·â†“ fâ†“) Î´â†“ â†¦ cnsâ†“ (Î´â†“ ttâ‚š)
    {-# REWRITE Î¼â†“-unit-l #-}

    Î¼â†“-assoc : âˆ€ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} {Xâ†“ : ğ•†â†“ â„“â†“ X}
      â†’ {f : Frm X} {c : Opr X f}
      â†’ {Î´ : (p : El (pos c)) â†’ Opr X (typ c p)}
      â†’ {Îµ : (p : El (pos (Î¼ c Î´))) â†’ Opr X (typ (Î¼ c Î´) p)}
      â†’ {fâ†“ : Frmâ†“ Xâ†“ f} (câ†“ : Oprâ†“ Xâ†“ fâ†“ c)
      â†’ (Î´â†“ : (p : El (pos c)) â†’ Oprâ†“ Xâ†“ (typâ†“ câ†“ p) (Î´ p))
      â†’ (Îµâ†“ : (p : El (pos (Î¼ c Î´))) â†’ Oprâ†“ Xâ†“ (typâ†“ (Î¼â†“ câ†“ Î´â†“) p) (Îµ p))
      â†’ Î¼â†“-cns (Î¼â†“ câ†“ Î´â†“) Îµâ†“ â†¦
          Î¼â†“-cns câ†“ (Î» p â†’ Î¼â†“ (Î´â†“ p) (Î» q â†’ Îµâ†“ âŸ¦ pos c , (Î» p â†’ pos (Î´ p)) âˆ£ p , q âŸ§â‚š))
    {-# REWRITE Î¼â†“-assoc #-}

  --
  --  Dependent constructors
  --

  Cnsâ†“ {n = O} Xâ†“ _ _ _ = âŠ¤
  Cnsâ†“ {n = S n} (Xâ†“â‚™ , Xâ†“â‚›â‚™) (lf f x) (fâ†“ , xâ†“ , Î·fâ†“â‚›) Ï„ =
    (Î·fâ†“â‚› â‰¡ Î·â†“-frm fâ†“ xâ†“) Ã—
    (Ï„ â‰¡ âŠ¥â‚š-Frmâ†“-rec {Xâ†“ = Xâ†“â‚™ , Xâ†“â‚›â‚™})
  Cnsâ†“ {n = S n} (Xâ†“â‚™ , Xâ†“â‚›â‚™) (nd x fâ‚›â‚™ Î´ Îµ) (fâ†“ , xâ†“ , Î¼fâ†“â‚›) Ï„ =
    Î£ (Frmâ†“â‚› Xâ†“â‚›â‚™ fâ‚›â‚™ fâ†“ xâ†“) (Î» fâ†“â‚›â‚™ â†’
    Î£ ((p : El (pos (opr fâ‚›â‚™))) â†’ Frmâ†“â‚› Xâ†“â‚›â‚™ (Î´ p) (typâ†“ (oprâ†“ fâ†“â‚›â‚™) p) (decâ†“ fâ†“â‚›â‚™ p)) (Î» Î´â†“ â†’
    Î£ ((p : El (pos (opr fâ‚›â‚™))) â†’ Oprâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (typâ†“ (oprâ†“ fâ†“â‚›â‚™) p , decâ†“ fâ†“â‚›â‚™ p , Î´â†“ p) (Îµ p)) (Î» Îµâ†“ â†’ 
    (Î¼fâ†“â‚› â‰¡ Î¼â†“-frm fâ†“â‚›â‚™ Î´â†“) Ã—
    (Ï„ â‰¡ âŠ”â‚š-Frmâ†“-rec {Xâ†“ = (Xâ†“â‚™ , Xâ†“â‚›â‚™)} (âŠ¤â‚š-Frmâ†“-rec {Xâ†“ = (Xâ†“â‚™ , Xâ†“â‚›â‚™)} (fâ†“ , xâ†“ , fâ†“â‚›â‚™))
         (Î£â‚š-Frmâ†“-rec {Xâ†“ = (Xâ†“â‚™ , Xâ†“â‚›â‚™)} (Î» p q â†’ typâ†“ (Îµâ†“ p) q))))))

  --
  --  "Smart" Constructors for leaves and nodes
  --

  lfâ†“ : âˆ€ {â„“ â„“â†“} {n : â„•} {Xâ‚™ : ğ•† â„“ n} {Xâ‚›â‚™ : Frm Xâ‚™ â†’ Set â„“}
    â†’ {Xâ†“â‚™ : ğ•†â†“ â„“â†“ Xâ‚™} {Xâ†“â‚›â‚™ : {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“}
    â†’ {f : Frm Xâ‚™} {x : Xâ‚›â‚™ f}
    â†’ (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (xâ†“ : Xâ†“â‚›â‚™ fâ†“ x)
    â†’ Cnsâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (lf f x)
        (fâ†“ , xâ†“ , Î·â†“-frm fâ†“ xâ†“)
        (âŠ¥â‚š-Frmâ†“-rec {Xâ†“ = Xâ†“â‚™ , Xâ†“â‚›â‚™})
  lfâ†“ fâ†“ xâ†“ = refl , refl 

  ndâ†“ : âˆ€ {â„“ â„“â†“} {n : â„•} {Xâ‚™ : ğ•† â„“ n} {Xâ‚›â‚™ : Frm Xâ‚™ â†’ Set â„“}
    â†’ {Xâ†“â‚™ : ğ•†â†“ â„“â†“ Xâ‚™} {Xâ†“â‚›â‚™ : {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“}
    â†’ {fâ‚™ : Frm Xâ‚™} {x : Xâ‚›â‚™ fâ‚™} {fâ‚›â‚™ : Frmâ‚› Xâ‚›â‚™ fâ‚™ x}
    â†’ {Î´ : (p : El (pos (opr fâ‚›â‚™))) â†’ Frmâ‚› Xâ‚›â‚™ (typ (opr fâ‚›â‚™) p) (dec fâ‚›â‚™ p)}
    â†’ {Îµ : (p : El (pos (opr fâ‚›â‚™))) â†’ Opr (Xâ‚™ , Xâ‚›â‚™) (typ (opr fâ‚›â‚™) p , dec fâ‚›â‚™ p , Î´ p)}
    â†’ {fâ†“â‚™ : Frmâ†“ Xâ†“â‚™ fâ‚™} (xâ†“ : Xâ†“â‚›â‚™ fâ†“â‚™ x) (fâ†“â‚›â‚™ : Frmâ†“â‚› Xâ†“â‚›â‚™ fâ‚›â‚™ fâ†“â‚™ xâ†“)
    â†’ (Î´â†“ : (p : El (pos (opr fâ‚›â‚™))) â†’ Frmâ†“â‚› Xâ†“â‚›â‚™ (Î´ p) (typâ†“ (oprâ†“ fâ†“â‚›â‚™) p) (decâ†“ fâ†“â‚›â‚™ p))
    â†’ (Îµâ†“ : (p : El (pos (opr fâ‚›â‚™))) â†’ Oprâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (typâ†“ (oprâ†“ fâ†“â‚›â‚™) p , decâ†“ fâ†“â‚›â‚™ p , Î´â†“ p) (Îµ p))
    â†’ Cnsâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (nd x fâ‚›â‚™ Î´ Îµ) (fâ†“â‚™ , xâ†“ , Î¼â†“-frm fâ†“â‚›â‚™ Î´â†“)
        (âŠ”â‚š-Frmâ†“-rec {inlâ‚š* = âŠ¤â‚š-Frm-rec (fâ‚™ , x , fâ‚›â‚™)}
                     {inrâ‚š* = Î£â‚š-Frm-rec (Î» p q â†’ typ (Îµ p) q)}
                     (âŠ¤â‚š-Frmâ†“-rec {Xâ†“ = Xâ†“â‚™ , Xâ†“â‚›â‚™} (fâ†“â‚™ , xâ†“ , fâ†“â‚›â‚™) )
                     (Î£â‚š-Frmâ†“-rec {Xâ†“ = Xâ†“â‚™ , Xâ†“â‚›â‚™} (Î» p q â†’ typâ†“ (Îµâ†“ p) q)))
  ndâ†“ xâ†“ fâ†“â‚›â‚™ Î´â†“ Îµâ†“ = fâ†“â‚›â‚™ , Î´â†“ , Îµâ†“ , refl , refl

  --
  --  Dependent Grafting
  --

  Î³â†“-cns : âˆ€ {â„“ â„“â†“} {n : â„•} {Xâ‚™ : ğ•† â„“ n} {Xâ‚›â‚™ : Frm Xâ‚™ â†’ Set â„“}
    â†’ {Xâ†“â‚™ : ğ•†â†“ â„“â†“ Xâ‚™} {Xâ†“â‚›â‚™ : {f : Frm Xâ‚™} (fâ†“ : Frmâ†“ Xâ†“â‚™ f) (x : Xâ‚›â‚™ f) â†’ Set â„“â†“}
    â†’ {fâ‚™ : Frm Xâ‚™} {x : Xâ‚›â‚™ fâ‚™} {fâ‚›â‚™ : Frmâ‚› Xâ‚›â‚™ fâ‚™ x}
    â†’ {c : Opr (Xâ‚™ , Xâ‚›â‚™) (fâ‚™ , x , fâ‚›â‚™)}
    â†’ {Î´ : (p : El (pos (opr fâ‚›â‚™))) â†’ Frmâ‚› Xâ‚›â‚™ (typ (opr fâ‚›â‚™) p) (dec fâ‚›â‚™ p)}
    â†’ {Îµ : (p : El (pos (opr fâ‚›â‚™))) â†’ Opr (Xâ‚™ , Xâ‚›â‚™) (typ (opr fâ‚›â‚™) p , dec fâ‚›â‚™ p , Î´ p)}
    â†’ {fâ†“â‚™ : Frmâ†“ Xâ†“â‚™ fâ‚™} {xâ†“ : Xâ†“â‚›â‚™ fâ†“â‚™ x} {fâ†“â‚›â‚™ : Frmâ†“â‚› Xâ†“â‚›â‚™ fâ‚›â‚™ fâ†“â‚™ xâ†“}
    â†’ (câ†“ : Oprâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (fâ†“â‚™ , xâ†“ , fâ†“â‚›â‚™) c)
    â†’ (Î´â†“ : (p : El (pos (opr fâ‚›â‚™))) â†’ Frmâ†“â‚› Xâ†“â‚›â‚™ (Î´ p) (typâ†“ (oprâ†“ fâ†“â‚›â‚™) p) (decâ†“ fâ†“â‚›â‚™ p))
    â†’ (Îµâ†“ : (p : El (pos (opr fâ‚›â‚™))) â†’ Oprâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (typâ†“ (oprâ†“ fâ†“â‚›â‚™) p , decâ†“ fâ†“â‚›â‚™ p , Î´â†“ p) (Îµ p))
    â†’ Cnsâ†“ (Xâ†“â‚™ , Xâ†“â‚›â‚™) (Î³-cns c Î´ Îµ) (fâ†“â‚™ , xâ†“ , Î¼â†“-frm fâ†“â‚›â‚™ Î´â†“)
        (âŠ”â‚š-Frmâ†“-rec {inlâ‚š* = typ c} {inrâ‚š* = Î£â‚š-Frm-rec (Î» p q â†’ typ (Îµ p) q)}
          (typâ†“ câ†“) (Î£â‚š-Frmâ†“-rec {Ï = Î» p q â†’ typ (Îµ p) q} (Î» p q â†’ typâ†“ (Îµâ†“ p) q))) 

  --
  --  Dependent Monadic Implementation
  --

  Î·â†“-cns {n = O} fâ†“ = tt
  Î·â†“-cns {n = S n} (fâ†“ , xâ†“ , Î¼fâ†“â‚›) =
    ndâ†“ xâ†“ Î¼fâ†“â‚›
      (Î» p â†’ Î·â†“-frm (typâ†“ (oprâ†“ Î¼fâ†“â‚›) p) (decâ†“ Î¼fâ†“â‚› p))
      (Î» p â†’ âŸª _ , lfâ†“ (typâ†“ (oprâ†“ Î¼fâ†“â‚›) p) (decâ†“ Î¼fâ†“â‚› p) âŸ«â‚’â‚šâ†“)

  Î¼â†“-cns {n = O} _ _ = tt
  Î¼â†“-cns {n = S n} {c = âŸª _ , _ , lf f x âŸ«â‚’â‚š} {fâ†“ = fâ†“â‚™ , xâ†“ , ._} âŸª _ , (refl , refl) âŸ«â‚’â‚šâ†“ Îºâ†“ = lfâ†“ fâ†“â‚™ xâ†“ 
  Î¼â†“-cns {n = S n} {c = âŸª _ , _ , nd x fâ‚›â‚™ Î´ Îµ âŸ«â‚’â‚š} {fâ†“ = fâ†“â‚™ , xâ†“ , ._} âŸª _ , (fâ†“â‚›â‚™ , Î´â†“ , Îµâ†“ , refl , refl) âŸ«â‚’â‚šâ†“ Îºâ†“ =
    let wâ†“ = Îºâ†“ (inlâ‚š (Î£â‚š (pos (opr fâ‚›â‚™)) (Î» p â†’ pos (Îµ p))) ttâ‚š)
        Îºâ†“' p q = Îºâ†“ (inrâ‚š âŠ¤â‚š âŸ¦ pos (opr fâ‚›â‚™) , (Î» pâ‚ â†’ pos (Îµ pâ‚)) âˆ£ p , q âŸ§â‚š)
        Ï•â†“ p = Î¼â†“ (Îµâ†“ p) (Îºâ†“' p)
    in Î³â†“-cns wâ†“ Î´â†“ Ï•â†“ 

  Î³â†“-cns {c = âŸª _ , _ , lf _ _ âŸ«â‚’â‚š} âŸª _ , (refl , refl) âŸ«â‚’â‚šâ†“ Ï•â†“ Ïˆâ†“ = cnsâ†“ (Ïˆâ†“ ttâ‚š)
  Î³â†“-cns {c = âŸª _ , _ , nd x fâ‚›â‚™ Î´ Îµ âŸ«â‚’â‚š} {xâ†“ = xâ†“} âŸª _ , (fâ†“â‚›â‚™ , Î´â†“ , Îµâ†“ , refl , refl) âŸ«â‚’â‚šâ†“ Ï•â†“ Ïˆâ†“ =
    let Ï•â†“' p q = Ï•â†“ âŸ¦ pos (opr fâ‚›â‚™) , (Î» p' â†’ pos (opr (Î´ p'))) âˆ£ p , q âŸ§â‚š
        Ïˆâ†“' p q = Ïˆâ†“ âŸ¦ pos (opr fâ‚›â‚™) , (Î» p' â†’ pos (opr (Î´ p'))) âˆ£ p , q âŸ§â‚š
        Î´â†“' p = Î¼â†“-frm (Î´â†“ p) (Ï•â†“' p)
        Îµâ†“' p = âŸª _ , Î³â†“-cns (Îµâ†“ p) (Ï•â†“' p) (Ïˆâ†“' p) âŸ«â‚’â‚šâ†“
    in ndâ†“ xâ†“ fâ†“â‚›â‚™ Î´â†“' Îµâ†“'

  --
  --  Dependent Opetopic Types
  --

  record ğ•†â†“âˆ {â„“ â„“â†“} {n : â„•} {X : ğ•† â„“ n} (Xâˆ : ğ•†âˆ X) (Xâ†“ : ğ•†â†“ â„“â†“ X)  : Set (â„“-max (â„“-suc â„“) (â„“-suc â„“â†“)) where
    coinductive
    field
      Headâ†“ : {f : Frm X} (fâ†“ : Frmâ†“ Xâ†“ f) (x : Head Xâˆ f) â†’ Set â„“â†“
      Tailâ†“ : ğ•†â†“âˆ (Tail Xâˆ) (Xâ†“ , Headâ†“)

  open ğ•†â†“âˆ public 
