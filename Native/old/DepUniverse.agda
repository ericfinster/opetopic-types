open import Core.Prelude
open import Native.Opetopes
open import Native.OpetopicType

module Native.Universe where

  --
  --  Signature 
  --

  ð•Œ : (â„“ : Level) (n : â„•) â†’ ð•†Type (â„“-suc â„“) n 

  data Frmâ†“ {â„“} : {n : â„•}
    â†’ {Î¿ : ð•† n} (f : Frm (ð•Œ â„“ n) Î¿) â†’ Type â„“

  data Webâ†“ {â„“} : {n : â„•}
    â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} 
    â†’ {Ï : â„™ Î¿} (Ï‰ : Web (ð•Œ â„“ n) f Ï)
    â†’ (fâ†“ : Frmâ†“ f) â†’ Type â„“ 

  Shpâ†“ : âˆ€ {â„“ n} 
    â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} 
    â†’ {Ï : â„™ Î¿} {Ï‰ : Web (ð•Œ â„“ n) f Ï}
    â†’ {fâ†“ : Frmâ†“ f} (Ï‰â†“ : Webâ†“ Ï‰ fâ†“)
    â†’ (p : Pos Ï) â†’ Frmâ†“ (Shp (ð•Œ â„“ n) Ï‰ p)

  --
  --  Monadic Structure
  --

  postulate
  
    Î·â†“ : âˆ€ {â„“ n} 
      â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿}
      â†’ (fâ†“ : Frmâ†“ f) â†’ Webâ†“ (Î· (ð•Œ â„“ n) f) fâ†“ 

    Î¼â†“ : âˆ€ {â„“ n} 
      â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} 
      â†’ {Ï : â„™ Î¿} {Ï‰ : Web (ð•Œ â„“ n) f Ï}
      â†’ {fâ†“ : Frmâ†“ f} (Ï‰â†“ : Webâ†“ Ï‰ fâ†“)
      â†’ {Î´ : (p : Pos Ï) â†’ â„™ (Typ Ï p)}
      â†’ {Ïµ : (p : Pos Ï) â†’ Web (ð•Œ â„“ n) (Shp (ð•Œ â„“ n) Ï‰ p) (Î´ p)}
      â†’ (Ïµâ†“ : (p : Pos Ï) â†’ Webâ†“  (Ïµ p) (Shpâ†“ Ï‰â†“ p))
      â†’ Webâ†“ (Î¼ (ð•Œ â„“ n) Ï‰ Ïµ) fâ†“

  --
  --  Equations 
  --

  postulate

    Shpâ†“-Î·â†“ : âˆ€ {â„“ n} 
      â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} 
      â†’ (fâ†“ : Frmâ†“ f) (p : Pos (Î·â‚’ Î¿))
      â†’ Shpâ†“ (Î·â†“ fâ†“) p â†¦ fâ†“
    {-# REWRITE Shpâ†“-Î·â†“ #-}

    Shpâ†“-Î¼â†“ : âˆ€ {â„“ n} 
      â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} 
      â†’ {Ï : â„™ Î¿} {Ï‰ : Web (ð•Œ â„“ n) f Ï}
      â†’ {fâ†“ : Frmâ†“ f} (Ï‰â†“ : Webâ†“ Ï‰ fâ†“)
      â†’ {Î´ : (p : Pos Ï) â†’ â„™ (Typ Ï p)}
      â†’ {Ïµ : (p : Pos Ï) â†’ Web (ð•Œ â„“ n) (Shp (ð•Œ â„“ n) Ï‰ p) (Î´ p)}
      â†’ (Ïµâ†“ : (p : Pos Ï) â†’ Webâ†“  (Ïµ p) (Shpâ†“ Ï‰â†“ p))
      â†’ (p : Pos (Î¼â‚’ Ï Î´))
      â†’ Shpâ†“ (Î¼â†“ Ï‰â†“ Ïµâ†“) p â†¦ Shpâ†“ (Ïµâ†“ (fstâ‚’ Ï Î´ p)) (sndâ‚’ Ï Î´ p) 
    {-# REWRITE Shpâ†“-Î¼â†“ #-} 

    --
    --  Monadic Laws
    --
    
    Î¼â†“-unit-r : âˆ€ {â„“ n} 
      â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} 
      â†’ {Ï : â„™ Î¿} {Ï‰ : Web (ð•Œ â„“ n) f Ï}
      â†’ (fâ†“ : Frmâ†“ f) (Ï‰â†“ : Webâ†“ Ï‰ fâ†“)
      â†’ Î¼â†“ Ï‰â†“ (Î» p â†’ Î·â†“ (Shpâ†“ Ï‰â†“ p)) â†¦ Ï‰â†“
    {-# REWRITE Î¼â†“-unit-r #-}
    
    Î¼â†“-unit-l : âˆ€ {â„“  n}
      â†’ {Î¿ : ð•† n} {Î´ : (p : Pos (Î·â‚’ Î¿)) â†’ â„™ Î¿}
      â†’ {f : Frm (ð•Œ â„“ n) Î¿}
      â†’ {Ïµ : (p : Pos (Î·â‚’ Î¿)) â†’ Web (ð•Œ â„“ n) (Shp (ð•Œ â„“ n) (Î· (ð•Œ â„“ n) f) p) (Î´ p)}
      â†’ (fâ†“ : Frmâ†“ f)
      â†’ (Ïµâ†“ : (p : Pos (Î·â‚’ Î¿)) â†’ Webâ†“ (Ïµ p) (Shpâ†“ (Î·â†“ fâ†“) p))
      â†’ Î¼â†“ (Î·â†“ fâ†“) Ïµâ†“ â†¦ Ïµâ†“ (Î·-posâ‚’ Î¿) 
    {-# REWRITE Î¼â†“-unit-l #-}

    Î¼â†“-assoc : âˆ€ {â„“ n} 
      â†’ {Î¿ : ð•† n} {Ï : â„™ Î¿} {Î´ : (p : Pos Ï) â†’ â„™ (Typ Ï p)}
      â†’ {f : Frm (ð•Œ â„“ n) Î¿} {Ï‰ : Web (ð•Œ â„“ n) f Ï}
      â†’ {Ïµ : (p : Pos Ï) â†’ Web (ð•Œ â„“ n) (Shp (ð•Œ â„“ n) Ï‰ p) (Î´ p)}
      â†’ {Ï• : (p : Pos (Î¼â‚’ Ï Î´)) â†’ â„™ (Typ (Î¼â‚’ Ï Î´) p)}
      â†’ {Ïˆ : (p : Pos (Î¼â‚’ Ï Î´)) â†’ Web (ð•Œ â„“ n) (Shp (ð•Œ â„“ n) (Î¼ (ð•Œ â„“ n) Ï‰ Ïµ) p) (Ï• p)}
      â†’ (fâ†“ : Frmâ†“ f) (Ï‰â†“ : Webâ†“ Ï‰ fâ†“)
      â†’ (Ïµâ†“ : (p : Pos Ï) â†’ Webâ†“ (Ïµ p) (Shpâ†“ Ï‰â†“ p))
      â†’ (Ïˆâ†“ : (p : Pos (Î¼â‚’ Ï Î´)) â†’ Webâ†“ (Ïˆ p) (Shpâ†“ (Î¼â†“ Ï‰â†“ Ïµâ†“) p))
      â†’ Î¼â†“ (Î¼â†“ Ï‰â†“ Ïµâ†“) Ïˆâ†“ â†¦ Î¼â†“ Ï‰â†“ (Î» p â†’ Î¼â†“ (Ïµâ†“ p) (Î» q â†’ Ïˆâ†“ (pairâ‚’ Ï Î´ p q)))
    {-# REWRITE Î¼â†“-assoc #-}

  --
  --  Decorated versions
  --

  Idxâ†“ : âˆ€ {â„“ n} â†’ Idx (ð•Œ â„“ n) â†’ Type â„“
  Idxâ†“ {n = n} (_ , f) = Frmâ†“ f

  ð•Œ-cell : âˆ€ {â„“ n} â†’ Idx (ð•Œ â„“ n) â†’ Type (â„“-suc â„“)
  ð•Œ-cell {â„“} i = (iâ†“ : Idxâ†“ i) â†’ Type â„“ 

  ð•Œ-el : âˆ€ {â„“ n} {i : Idx (ð•Œ â„“ n)}
    â†’ ð•Œ-cell i â†’ Idxâ†“ i â†’ Type â„“
  ð•Œ-el P i = P i 

  Srcâ†“ : âˆ€ {â„“ n} {i : Idx (ð•Œ â„“ n)}
    â†’ {P : Idx (ð•Œ â„“ n) â†’ Type (â„“-suc â„“)}
    â†’ (Q : {i : Idx (ð•Œ â„“ n)} â†’ P i â†’ Idxâ†“ i â†’ Type â„“)
    â†’ Src (ð•Œ â„“ n) P i
    â†’ Idxâ†“ i â†’ Type â„“
  Srcâ†“ {i = Î¿ , f} Q (Ï , Ï‰ , Î´) fâ†“ = 
    Î£[ Ï‰â†“ âˆˆ Webâ†“ Ï‰ fâ†“  ]
    ((p : Pos Ï) â†’ Q (Î´ p) (Shpâ†“ Ï‰â†“ p))
    
  retâ†“ : âˆ€ {â„“ n} 
    â†’ {P : Idx (ð•Œ â„“ n) â†’ Type (â„“-suc â„“)}
    â†’ (Q : {i : Idx (ð•Œ â„“ n)} â†’ P i â†’ Idxâ†“ i â†’ Type â„“)
    â†’ {i : Idx (ð•Œ â„“ n)} {t : P i}
    â†’ {iâ†“ : Idxâ†“ i} (tâ†“ : Q t iâ†“)
    â†’ Srcâ†“ Q (ret (ð•Œ â„“ n) P t) iâ†“
  retâ†“ Q {iâ†“ = iâ†“} tâ†“ = Î·â†“ iâ†“ , cst tâ†“ 

  joinâ†“ : âˆ€ {â„“ n} 
    â†’ {P : Idx (ð•Œ â„“ n) â†’ Type (â„“-suc â„“)}
    â†’ (Q : {i : Idx (ð•Œ â„“ n)} â†’ P i â†’ Idxâ†“ i â†’ Type â„“)
    â†’ {i : Idx (ð•Œ â„“ n)} {s : Src (ð•Œ â„“ n) (Src (ð•Œ â„“ n) P) i}
    â†’ {iâ†“ : Idxâ†“ i} (sâ†“ : Srcâ†“ (Srcâ†“ Q) s iâ†“) 
    â†’ Srcâ†“ Q (join (ð•Œ â„“ n) P s) iâ†“ 
  joinâ†“ Q {s = Ï , Ï‰ , Î´} (Ï‰â†“ , Î´â†“) =
    Î¼â†“ Ï‰â†“ (Î» p â†’ Î´â†“ p .fst) , 
    (Î» pq â†’ let p = fstâ‚’ Ï (Î» p â†’ Î´ p .fst) pq
                q = sndâ‚’ Ï (Î» p â†’ Î´ p .fst) pq
             in Î´â†“ p .snd q)
             
  --
  --  Implementations
  --

  ð•Œ â„“ zero = â—‹
  ð•Œ â„“ (suc n) = ð•Œ â„“ n âˆ¥ ð•Œ-cell

  {-# NO_UNIVERSE_CHECK #-}
  {-# NO_POSITIVITY_CHECK #-}
  data Frmâ†“ {â„“} where

    â—â†“ : Frmâ†“ â— 

    _â–ºâŸ¦_âˆ£_âŸ§â†“ : {n : â„•}
      â†’ {Î¿ : ð•† n} {F : Frm (ð•Œ â„“ n) Î¿}
      â†’ {T : Idxâ†“ (Î¿ , F) â†’ Type â„“}
      â†’ {S : Src (ð•Œ â„“ n) ð•Œ-cell (Î¿ , F)}
      â†’ (fâ†“ : Frmâ†“ F) (tâ†“ : T fâ†“)
      â†’ (sâ†“ : Srcâ†“ ð•Œ-el S fâ†“)
      â†’ Frmâ†“ (F â–ºâŸ¦ T âˆ£ S âŸ§)

  Branchâ†“ : âˆ€ {â„“ n} 
    â†’ {Î¿ : ð•† n} {f : Frm (ð•Œ â„“ n) Î¿} {t : ð•Œ-cell (Î¿ , f)}
    â†’ (b : Branch (ð•Œ â„“ n) ð•Œ-cell t)
    â†’ {fâ†“ : Frmâ†“ f} (tâ†“ : t fâ†“)
    â†’ Type â„“
  Branchâ†“ {Î¿} {f} {t} (s , tr , Ï‰) {fâ†“} tâ†“ =
    Î£[ sâ†“ âˆˆ Srcâ†“ ð•Œ-el s fâ†“ ]
    Webâ†“ Ï‰ ((fâ†“ â–ºâŸ¦ tâ†“ âˆ£ sâ†“ âŸ§â†“))

  {-# NO_UNIVERSE_CHECK #-}
  data Webâ†“ {â„“} where 

    arrâ†“ : Webâ†“ arr â—â†“ 

    lfâ†“ : {n : â„•}
       â†’ {Î¿ : ð•† n} {F : Frm (ð•Œ â„“ n) Î¿} {T : ð•Œ-cell (Î¿ , F)}
       â†’ {fâ†“ : Frmâ†“ F} (tâ†“ : T fâ†“)
       â†’ Webâ†“ (lf T) (fâ†“ â–ºâŸ¦ tâ†“ âˆ£ retâ†“ ð•Œ-el {t = T} tâ†“ âŸ§â†“)

    ndâ†“ : {n : â„•} 
       â†’ {Î¿ : ð•† n} {F : Frm (ð•Œ â„“ n) Î¿} {T : ð•Œ-cell (Î¿ , F)}
       â†’ {S : Src (ð•Œ â„“ n) ð•Œ-cell (Î¿ , F)}
       â†’ {Î” : (p : Pos (S .fst)) â†’ Branch (ð•Œ â„“ n) ð•Œ-cell (S .snd .snd p)}
       â†’ {fâ†“ : Frmâ†“ F} (tâ†“ : T fâ†“) (sâ†“ : Srcâ†“ ð•Œ-el S fâ†“)
       â†’ (Î´â†“ : (p : Pos (S .fst)) -> Branchâ†“ (Î” p) (sâ†“ .snd p))
       â†’ Webâ†“ (nd T S Î”) (fâ†“ â–ºâŸ¦ tâ†“ âˆ£ joinâ†“ ð•Œ-el {s = (S .fst , S .snd .fst , Î» p â†’ Î” p .fst)} (sâ†“ .fst , Î» p â†’ Î´â†“ p .fst) âŸ§â†“)
                                                
  Shpâ†“ arrâ†“ this = â—â†“
  Shpâ†“ (ndâ†“ {fâ†“ = fâ†“} tâ†“ sâ†“ Î´â†“) here = fâ†“ â–ºâŸ¦ tâ†“ âˆ£ sâ†“ âŸ§â†“
  Shpâ†“ (ndâ†“ {fâ†“ = fâ†“} tâ†“ sâ†“ Î´â†“) (there p q) = Shpâ†“ (Î´â†“ p .snd) q
  
  -- Î·â†“ â—‹â†“ â—â†“ = arrâ†“ 
  -- Î·â†“ (Xâ†“ âˆ¥â†“ Pâ†“) (fâ†“ â–ºâŸ¦ tâ†“ âˆ£ sâ†“ âŸ§â†“) =
  --   ndâ†“ tâ†“ sâ†“ (Î» p â†’ _ , lfâ†“ (sâ†“ .snd p))

  -- Î³â†“ : âˆ€ {â„“ â„“â†“ n} {X : ð•†Type â„“ n} (Xâ†“ : ð•†Typeâ†“ â„“â†“ X)
  --   â†’ {P : Idx X â†’ Type â„“}
  --   â†’ (Pâ†“ : {i : Idx X} â†’ P i â†’  Idxâ†“ Xâ†“ i â†’ Type â„“â†“)
  --   â†’ {Î¿ : ð•† n} {f : Frm X Î¿} {t : P (Î¿ , f)} {s : Src X P (Î¿ , f)}
  --   â†’ {Ï„ : â„™ (Î¿ âˆ£ s .fst)} {Ï‰ : Web (X âˆ¥ P) (f â–ºâŸ¦ t âˆ£ s âŸ§) Ï„}
  --   â†’ {Ï• : (p : Pos (s .fst)) â†’ Branch X P (s .snd .snd p)}
  --   â†’ {fâ†“ : Frmâ†“ Xâ†“ f} {tâ†“ : Pâ†“ t fâ†“} {sâ†“ : Srcâ†“ Xâ†“ Pâ†“ s fâ†“}
  --   â†’ (Ï‰â†“ : Webâ†“ (Xâ†“ âˆ¥â†“ Pâ†“) (fâ†“ â–ºâŸ¦ tâ†“ âˆ£ sâ†“ âŸ§â†“) Ï‰)
  --   â†’ (Ï•â†“ : (p : Pos (s .fst)) -> Branchâ†“ Xâ†“ Pâ†“ (Ï• p) (sâ†“ .snd p))
  --   â†’ Webâ†“ (Xâ†“ âˆ¥â†“ Pâ†“) (fâ†“ â–ºâŸ¦ tâ†“ âˆ£ joinâ†“ Xâ†“ Pâ†“ (sâ†“ .fst , Î» p â†’ Ï•â†“ p .fst) âŸ§â†“) (Î³ X P Ï‰ Ï•)
  -- Î³â†“ Xâ†“ Pâ†“ (lfâ†“ tâ†“) Ï•â†“ = Ï•â†“ (Î·-posâ‚’ _) .snd
  -- Î³â†“ Xâ†“ Pâ†“ {Ï‰ = nd t s Î´} (ndâ†“ tâ†“ sâ†“ Î´â†“) Ï•â†“ = 
  --   ndâ†“ tâ†“ sâ†“ (Î» p â†’ _ , Î³â†“ Xâ†“ Pâ†“ (Î´â†“ p .snd) (Î» q â†’ Ï•â†“ (pairâ‚’ (s .fst) (Î» r â†’ Î´ r .fst .fst) p q)))

  -- Î¼â†“ â—‹â†“ arrâ†“ Ï• = arrâ†“
  -- Î¼â†“ (Xâ†“ âˆ¥â†“ Pâ†“) (lfâ†“ tâ†“) Ï• = lfâ†“ tâ†“
  -- Î¼â†“ (Xâ†“ âˆ¥â†“ Pâ†“) (ndâ†“ tâ†“ sâ†“ Î´â†“) Ï•â†“ = 
  --   Î³â†“ Xâ†“ Pâ†“ (Ï•â†“ here) (Î» p â†’ _ , Î¼â†“ (Xâ†“ âˆ¥â†“ Pâ†“) (Î´â†“ p .snd) (Î» q â†’ Ï•â†“ (there p q)))
