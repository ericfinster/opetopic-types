{-# OPTIONS --without-K --rewriting #-}

open import HoTT
open import Monad
open import MonadOver
open import Pb
open import OpetopicType

module Lemmas where

  -- Just going to accumulate random lemmas that clog the typechecker
  -- here so that we can use them in what follows...

  rotate : âˆ€ {â„“} {A : Type â„“} {aâ‚€ aâ‚ aâ‚‚ : A}
    â†’ (p : aâ‚€ == aâ‚) (q : aâ‚‚ == aâ‚) (r : aâ‚€ == aâ‚‚)
    â†’ p âˆ™ ! q == r
    â†’ p == r âˆ™ q
  rotate idp idp r s = s âˆ™ ! (âˆ™-unit-r r)

  pth-algâ‚€ : âˆ€ {â„“} {A : Set â„“} {aâ‚€ aâ‚ aâ‚‚ : A}
    â†’ (p : aâ‚€ == aâ‚) (q : aâ‚‚ == aâ‚) 
    â†’ p == (p âˆ™ ! q) âˆ™ q 
  pth-algâ‚€ idp idp = idp

  pth-algâ‚ : âˆ€ {â„“} {A : Set â„“} {aâ‚€ aâ‚ aâ‚‚ : A}
    â†’ (p : aâ‚€ == aâ‚‚) (q : aâ‚ == aâ‚€) 
    â†’ p == (! q âˆ™ idp) âˆ™ q âˆ™ p
  pth-algâ‚ idp idp = idp 

  -- Lemma about transporting in constructors
  typ-trans-inv : (M : ğ•„) (Mâ†“ : ğ•„â†“ M)
    â†’ {i : Idx M} {c : Cns M i}
    â†’ {j j' : Idxâ†“ Mâ†“ i} (e : j == j')
    â†’ (d : Cnsâ†“ Mâ†“ j c) (p : Pos M c)
    â†’ Typâ†“ Mâ†“ (transport (Î» x â†’ Cnsâ†“ Mâ†“ x c) e d) p == Typâ†“ Mâ†“ d p
  typ-trans-inv M Mâ†“ idp d p = idp

  fst=-comm : âˆ€ {i j} {A : Type i} {B : A â†’ Type j}
    â†’ {x y z : Î£ A B} (p : y == x) (q : y == z)
    â†’ fst= (! p âˆ™ q) == ! (fst= p) âˆ™ fst= q
  fst=-comm idp idp = idp

  Î£-fst-triv-lemâ‚€ : âˆ€ {i j} {A : Type i} {B : A â†’ Type j}
    â†’ {a : A} {bâ‚€ bâ‚ : B a} (p : Path {A = Î£ A B} (a , bâ‚€) (a , bâ‚))
    â†’ (q : fst= p == idp)
    â†’ bâ‚€ == bâ‚
  Î£-fst-triv-lemâ‚€ {B = B} {bâ‚€ = bâ‚€} {bâ‚ = bâ‚} p q =
    transport (Î» x â†’ bâ‚€ == bâ‚ [ B â†“ x ]) q (snd= p) 
  
  Î£-fst-triv-lemâ‚ : âˆ€ {i j k} {A : Type i} {B : A â†’ Type j}
    â†’ {C : Î£ A B â†’ Type k}
    â†’ {a : A} {bâ‚€ bâ‚ : B a} (p : (a , bâ‚€) == (a , bâ‚))
    â†’ (q : fst= p == idp)
    â†’ {x : C (a , bâ‚€)} {y : C (a , bâ‚)}
    â†’ x == y [ C â†“ p ]
    â†’ x == y [ (Î» b â†’ C (a , b)) â†“ Î£-fst-triv-lemâ‚€ p q ] 
  Î£-fst-triv-lemâ‚ {B = B} {C = C} {a = a} {bâ‚€ = bâ‚€} {bâ‚ = bâ‚} p q {x} {y} r =
    â†“-ap-out C (a ,_) (Î£-fst-triv-lemâ‚€ p q) (transport (Î» z â†’ x == y [ C â†“ z ]) pth r)

    where pth : p == pair= idp (Î£-fst-triv-lemâ‚€ p q)
          pth = pair=-Î· p âˆ™ (ap (Î» z â†’ pair= (fst z) (snd z))
            (pair= q (from-transp (Î» z â†’ bâ‚€ == bâ‚ [ B â†“ z ]) q {u = snd= p} idp)))

  --
  -- Various generic lemmas about indices and so on in the slice
  -- generated by a monad over ....
  --
  
  module SliceOver (M : ğ•„) (Mâ†“ : ğ•„â†“ M) where

    Plbk : ğ•„
    Plbk = Pb M (Idxâ†“ Mâ†“)

    Plbkâ†“ : ğ•„â†“ Plbk
    Plbkâ†“ = Pbâ†“ Mâ†“ (Idxâ†“ Mâ†“) (Î» i j k â†’ j == k)
    
    Slc : ğ•„
    Slc = Slice Plbk

    Slcâ†“ : ğ•„â†“ Slc
    Slcâ†“ = Sliceâ†“ Plbkâ†“
  
    -- An explicit description of equalities in Idxâ†“ Slcâ†“ 
    slc-idx-lem : (i : Idx M) (j : Idxâ†“ Mâ†“ i)
      â†’ (c : Cns M i) (Î½ : (p : Pos M c) â†’ Idxâ†“ Mâ†“ (Typ M c p))
      â†’ {jâ‚€ : Idxâ†“ Mâ†“ i} {eâ‚€ : jâ‚€ == j}
      â†’ {dâ‚€ : Cnsâ†“ Mâ†“ jâ‚€ c} {Î±â‚€ : (p : Pos M c) â†’ Typâ†“ Mâ†“ dâ‚€ p == Î½ p}
      â†’ {jâ‚ : Idxâ†“ Mâ†“ i} {eâ‚ : jâ‚ == j}
      â†’ {dâ‚ : Cnsâ†“ Mâ†“ jâ‚ c} {Î±â‚ : (p : Pos M c) â†’ Typâ†“ Mâ†“ dâ‚ p == Î½ p}
      â†’ (q : jâ‚€ == jâ‚) (r : eâ‚€ == q âˆ™ eâ‚)
      â†’ (s : transport (Î» x â†’ Cnsâ†“ Mâ†“ x c) q dâ‚€ == dâ‚)
      â†’ (t : (p : Pos M c) â†’ Î±â‚€ p == (! (typ-trans-inv M Mâ†“ q dâ‚€ p) âˆ™ ap (Î» x â†’ Typâ†“ Mâ†“ x p) s) âˆ™ Î±â‚ p)
      â†’ Path {A = Idxâ†“ Slcâ†“ ((i , j) , c , Î½)}
        ((jâ‚€ , eâ‚€) , (dâ‚€ , Î±â‚€)) ((jâ‚ , eâ‚) , (dâ‚ , Î±â‚)) 
    slc-idx-lem i j c Î½ idp idp idp t =
      pair= idp (pair= idp (Î»= t))

    slc-idx-lem-coh : (i : Idx M) (j : Idxâ†“ Mâ†“ i)
      â†’ (c : Cns M i) (Î½ : (p : Pos M c) â†’ Idxâ†“ Mâ†“ (Typ M c p))
      â†’ {jâ‚€ : Idxâ†“ Mâ†“ i} {eâ‚€ : jâ‚€ == j}
      â†’ {dâ‚€ : Cnsâ†“ Mâ†“ jâ‚€ c} {Î±â‚€ : (p : Pos M c) â†’ Typâ†“ Mâ†“ dâ‚€ p == Î½ p}
      â†’ {jâ‚ : Idxâ†“ Mâ†“ i} {eâ‚ : jâ‚ == j}
      â†’ {dâ‚ : Cnsâ†“ Mâ†“ jâ‚ c} {Î±â‚ : (p : Pos M c) â†’ Typâ†“ Mâ†“ dâ‚ p == Î½ p}
      â†’ (q : jâ‚€ == jâ‚) (r : eâ‚€ == q âˆ™ eâ‚)
      â†’ (s : transport (Î» x â†’ Cnsâ†“ Mâ†“ x c) q dâ‚€ == dâ‚)
      â†’ (t : (p : Pos M c) â†’ Î±â‚€ p == (! (typ-trans-inv M Mâ†“ q dâ‚€ p) âˆ™ ap (Î» x â†’ Typâ†“ Mâ†“ x p) s) âˆ™ Î±â‚ p)
      â†’ fst= (slc-idx-lem i j c Î½ q r s t) == pair= q (â†“-idf=cst-in r)
    slc-idx-lem-coh i j c Î½ idp idp idp t = fst=-Î² idp (pair= idp (Î»= t)) 

    module Helpers (i : Idx M) (j : Idxâ†“ Mâ†“ i)
             (c : Cns M i) (Î½ : (p : Pos M c) â†’ Idxâ†“ Mâ†“ (Typ M c p))
             (Î´ : (p : Pos M c) â†’ Cns Plbk (Typ M c p , Î½ p))
             (Îµ : (p : Pos M c) â†’ Cns Slc ((Typ M c p , Î½ p) , Î´ p))
             (d : Cnsâ†“ Mâ†“ j c) (typ-d=Î½ : (p : Pos M c) â†’ Typâ†“ Mâ†“ d p == Î½ p) where

      Î¼f = Î¼-pos-fst M c (fst âˆ˜ Î´)
      Î¼s = Î¼-pos-snd M c (fst âˆ˜ Î´)

      Î´Î¼ : (pq : Pos M (Î¼ M c (fst âˆ˜ Î´)))
        â†’ Idxâ†“ Mâ†“ (Typ M (fst (Î´ (Î¼f pq))) (Î¼s pq))
      Î´Î¼ pq = snd (Î´ (Î¼f pq)) (Î¼s pq) 

      Î´â†“Î¼ : (Î´â†“ : (p : Pos M c) â†’ Cnsâ†“ Plbkâ†“ (Typâ†“ Mâ†“ d p , typ-d=Î½ p) (Î´ p))
        â†’ (pq : Pos M (Î¼ M c (fst âˆ˜ Î´)))
        â†’ Typâ†“ Mâ†“ (fst (Î´â†“ (Î¼f pq))) (Î¼s pq)
        == snd (Î´ (Î¼f pq)) (Î¼s pq)
      Î´â†“Î¼ Î´â†“ pq = snd (Î´â†“ (Î¼f pq)) (Î¼s pq) 

      Î´-set : Set
      Î´-set = (p : Pos M c) â†’ Cnsâ†“ Plbkâ†“ (Typâ†“ Mâ†“ d p , typ-d=Î½ p) (Î´ p)

      Îµ-fib : Î´-set â†’ Set
      Îµ-fib Î´â†“ = (p : Pos M c) â†’ Cnsâ†“ Slcâ†“ ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , Î´â†“ p) (Îµ p)

      Î£-Î´Îµ : Set 
      Î£-Î´Îµ = Î£ Î´-set Îµ-fib

      Idxâ†“Slcâ†“Slcâ†“ : Set
      Idxâ†“Slcâ†“Slcâ†“ = Î£ (Idxâ†“ Slcâ†“ ((i , j) , (Î¼ M c (fst âˆ˜ Î´) , Î´Î¼))) (Î» i â†’ Cnsâ†“ Slcâ†“ i (nd (c , Î½) Î´ Îµ))

      ndâ†“-map : Î£-Î´Îµ â†’ Idxâ†“Slcâ†“Slcâ†“
      ndâ†“-map (Î´â†“ , Îµâ†“) = ((j , idp) , (Î¼â†“ Mâ†“ d (fst âˆ˜ Î´â†“) , Î´â†“Î¼ Î´â†“)) , ndâ†“ (d , typ-d=Î½) Î´â†“ Îµâ†“

      -- Some id-elims on decoration types
      module _ (Î´â†“â‚€ Î´â†“â‚ : Î´-set) (Îµâ†“â‚€ : Îµ-fib Î´â†“â‚€) (Îµâ†“â‚ : Îµ-fib Î´â†“â‚) where

        ap-ndâ†“-map : (p : Î´â†“â‚€ == Î´â†“â‚) (q : Îµâ†“â‚€ == Îµâ†“â‚ [ Îµ-fib â†“ p ])
          â†’ ndâ†“ (d , typ-d=Î½) Î´â†“â‚€ Îµâ†“â‚€ == ndâ†“ (d , typ-d=Î½) Î´â†“â‚ Îµâ†“â‚
                [ (Î» x â†’ Cnsâ†“ Slcâ†“ x (nd (c , Î½) Î´ Îµ)) â†“ ap ((j , idp) ,_) (ap (Î» x â†’ Î¼â†“ Mâ†“ d (fst âˆ˜ x) , Î´â†“Î¼ x) p) ]
        ap-ndâ†“-map idp idp = idp

        idx-slc-slc-pth : (p : Î´â†“â‚€ == Î´â†“â‚) (q : Îµâ†“â‚€ == Îµâ†“â‚ [ Îµ-fib â†“ p ])
          â†’ ndâ†“-map (Î´â†“â‚€ , Îµâ†“â‚€) == ndâ†“-map (Î´â†“â‚ , Îµâ†“â‚)
        idx-slc-slc-pth p q = pair= (pair= idp (ap (Î» x â†’ Î¼â†“ Mâ†“ d (fst âˆ˜ x) , Î´â†“Î¼ x) p))
                            (ap-ndâ†“-map p q) 

        slc-typ-cst : (p : Î´â†“â‚€ == Î´â†“â‚) (q : Îµâ†“â‚€ == Îµâ†“â‚ [ Îµ-fib â†“ p ])
          â†’ Path {A = Path {A = Idxâ†“ Slcâ†“ ((i , j) , (c , Î½))} ((j , idp) , (d , typ-d=Î½)) ((j , idp) , (d , typ-d=Î½))}
                 idp (ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) true) (idx-slc-slc-pth p q) âˆ™ idp)
        slc-typ-cst idp idp = idp

        -- Okay, let's work on the other side. So I think the point is that
        -- isp should be expressible in terms of this slice lemma thing.

    -- -- An explicit description of equalities in Idxâ†“ Slcâ†“ 
    -- slc-idx-lem : (i : Idx M) (j : Idxâ†“ Mâ†“ i)
    --   â†’ (c : Cns M i) (Î½ : (p : Pos M c) â†’ Idxâ†“ Mâ†“ (Typ M c p))
    --   â†’ {jâ‚€ : Idxâ†“ Mâ†“ i} {eâ‚€ : jâ‚€ == j}
    --   â†’ {dâ‚€ : Cnsâ†“ Mâ†“ jâ‚€ c} {Î±â‚€ : (p : Pos M c) â†’ Typâ†“ Mâ†“ dâ‚€ p == Î½ p}
    --   â†’ {jâ‚ : Idxâ†“ Mâ†“ i} {eâ‚ : jâ‚ == j}
    --   â†’ {dâ‚ : Cnsâ†“ Mâ†“ jâ‚ c} {Î±â‚ : (p : Pos M c) â†’ Typâ†“ Mâ†“ dâ‚ p == Î½ p}
    --   â†’ (q : jâ‚€ == jâ‚) (r : eâ‚€ == q âˆ™ eâ‚)
    --   â†’ (s : transport (Î» x â†’ Cnsâ†“ Mâ†“ x c) q dâ‚€ == dâ‚)
    --   â†’ (t : (p : Pos M c) â†’ Î±â‚€ p == (! (typ-trans-inv M Mâ†“ q dâ‚€ p) âˆ™ ap (Î» x â†’ Typâ†“ Mâ†“ x p) s) âˆ™ Î±â‚ p)
    --   â†’ Path {A = Idxâ†“ Slcâ†“ ((i , j) , c , Î½)}
    --     ((jâ‚€ , eâ‚€) , (dâ‚€ , Î±â‚€)) ((jâ‚ , eâ‚) , (dâ‚ , Î±â‚)) 
    -- slc-idx-lem i j c Î½ idp idp idp t =
    --   pair= idp (pair= idp (Î»= t))




        module _ (p : Pos M c) (q : Pos Slc (Îµ p))
                 (r : Î´â†“â‚€ == Î´â†“â‚) (s : Îµâ†“â‚€ == Îµâ†“â‚ [ Îµ-fib â†“ r ])
                 (idx-ih : Idxâ†“ Slcâ†“ ((Typ M c p , Î½ p) , Î´ p))
                 (cns-ih : Cnsâ†“ Slcâ†“ idx-ih (Îµ p))
                 (idx-u-ih : idx-ih == ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , Î´â†“â‚ p))
                 (cns-u-ih : cns-ih == Îµâ†“â‚ p [ (Î» x â†’ Cnsâ†“ Slcâ†“ x (Îµ p)) â†“ idx-u-ih ])
          where

            Î´â†“' : Î´-set
            Î´â†“' p = {!!} , {!!}

            okay : Path {A = Path {A = Idxâ†“ Slcâ†“ (Typâ‚› (Pb M (Idxâ†“ Mâ†“)) (Îµ p) q)} (Typâ†“ Slcâ†“ (Îµâ†“â‚€ p) q) (Typâ†“ Slcâ†“ (Îµâ†“â‚ p) q)}
              ({!typ-trans-inv Slc Slcâ†“ ? cns-ih q!} âˆ™ (ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) q) (pair= idx-u-ih cns-u-ih)))
              (ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) (inr (p , q))) (idx-slc-slc-pth r s))
            okay = {!!}

      -- ndâ†“-map : Î£-Î´Îµ â†’ Idxâ†“Slcâ†“Slcâ†“
      -- ndâ†“-map (Î´â†“ , Îµâ†“) = ((j , idp) , (Î¼â†“ Mâ†“ d (fst âˆ˜ Î´â†“) , Î´â†“Î¼ Î´â†“)) , ndâ†“ (d , typ-d=Î½) Î´â†“ Îµâ†“


  -- typ-trans-inv : (M : ğ•„) (Mâ†“ : ğ•„â†“ M)
  --   â†’ {i : Idx M} {c : Cns M i}
  --   â†’ {j j' : Idxâ†“ Mâ†“ i} (e : j == j')
  --   â†’ (d : Cnsâ†“ Mâ†“ j c) (p : Pos M c)
  --   â†’ Typâ†“ Mâ†“ (transport (Î» x â†’ Cnsâ†“ Mâ†“ x c) e d) p == Typâ†“ Mâ†“ d p
  -- typ-trans-inv M Mâ†“ idp d p = idp



          -- we-need : typ-trans-inv Slc Slcâ†“ {!other!} cns-ih q âˆ™
          --           ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) q) (pair= idx-u-ih cns-u-ih)
          --           == ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) (inr (p , q))) (idx-slc-slc-pth r s) 
          -- we-need = {!!}

          -- suffices : typ-trans-inv Slc Slcâ†“ (idx-ih-coh p) (cns-ih p) q âˆ™ 
          --            ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) q) (pair= (idx-u-ih p) (cns-u-ih p))
          --            == ap (Î» x â†’ Typâ†“ Slcâ†“ (snd x) (inr (p , q))) isp


      module _ (Î´â†“â‚€ Î´â†“â‚ : Î´-set) (Î´-eq : (p : Pos M c) â†’ Î´â†“â‚€ p == Î´â†“â‚ p) where

        pb-pth : Path {A = Cnsâ†“ Plbkâ†“ (j , idp) (Î¼ M c (fst âˆ˜ Î´) , Î´Î¼)}
                    (Î¼â†“ Mâ†“ d (fst âˆ˜ Î´â†“â‚€) , Î´â†“Î¼ Î´â†“â‚€)
                    (Î¼â†“ Mâ†“ d (fst âˆ˜ Î´â†“â‚) , Î´â†“Î¼ Î´â†“â‚)
        pb-pth = ap (Î» x â†’ Î¼â†“ Mâ†“ d (fst âˆ˜ x) , Î´â†“Î¼ x) (Î»= Î´-eq)

        module _ (Îµâ†“â‚€ : Îµ-fib Î´â†“â‚€) (Îµâ†“â‚ : Îµ-fib Î´â†“â‚)
                 (Îµ-eq : (p : Pos M c) â†’ Îµâ†“â‚€ p == Îµâ†“â‚ p [ (Î» x â†’ Cnsâ†“ Slcâ†“ ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , x) (Îµ p)) â†“ Î´-eq p ]) where

          Îµ-eq' : (p : Pos M c) â†’ Îµâ†“â‚€ p == Îµâ†“â‚ p [ (Î» x â†’ Cnsâ†“ Slcâ†“ ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , x) (Îµ p)) â†“ app= (Î»= Î´-eq) p ]
          Îµ-eq' p = transport (Î» z â†’ Îµâ†“â‚€ p == Îµâ†“â‚ p [ (Î» x â†’ Cnsâ†“ Slcâ†“ ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , x) (Îµ p)) â†“ z ])
                              (! (app=-Î² Î´-eq p)) (Îµ-eq p)
          
          Î»=Îµâ†“ : Îµâ†“â‚€ == Îµâ†“â‚ [ (Î» x â†’ (p : Pos M c) â†’ Cnsâ†“ Slcâ†“ ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , x p) (Îµ p)) â†“ Î»= Î´-eq ]
          Î»=Îµâ†“ = â†“-Î -cst-app-in (Î» p â†’
            â†“-ap-out (Î» x â†’ Cnsâ†“ Slcâ†“ ((Typâ†“ Mâ†“ d p , typ-d=Î½ p) , x) (Îµ p)) (Î» x â†’ x p)
                     (Î»= Î´-eq) (Îµ-eq' p))

          ndâ†“-pth :  ndâ†“ {fâ†“ = j , idp} (d , typ-d=Î½) Î´â†“â‚€ Îµâ†“â‚€
                == ndâ†“ {fâ†“ = j , idp} (d , typ-d=Î½) Î´â†“â‚ Îµâ†“â‚
                     [ (Î» x â†’ Cnsâ†“ Slcâ†“ x (nd (c , Î½) Î´ Îµ)) â†“ ap (Î» x â†’ (j , idp) , x) pb-pth ] 
          ndâ†“-pth = ap-ndâ†“-map Î´â†“â‚€ Î´â†“â‚ Îµâ†“â‚€ Îµâ†“â‚ (Î»= Î´-eq) Î»=Îµâ†“


  
